@using PagedList.Mvc;
@using PagedList;
@model PagedList.PagedList<JN.Data.ExchangeCurrency>
@{
    string action = ViewContext.RouteData.Values["action"].ToString().ToLower();
    Layout = "~/Areas/AdminCenter/Views/Shared/_Layout.cshtml";
}
<!-- Content -->
<div id="content">
    <!-- Breadcrumb -->
    <ul class="breadcrumb">
        <li><a href="@Url.Action("Index", "Home")" class="glyphicons home"><i></i> 首页</a></li>
        <li class="divider"></li>
        <li>@ViewBag.Title</li>
    </ul>
    <div class="separator bottom"></div>
    <!-- // Breadcrumb END -->
    <div class="innerLR">
        <div class="tabbable">
            <ul class="nav nav-tabs" id="myTab">
                <li class="@((action == "rulerlist") ? "active" : "")">
                    <a href="@(Url.Action("rulerlist"))">
                        使用中的规则
                    </a>
                </li>
                <li class="@(action == "offsales" ? "active" : "")">
                    <a href="@(Url.Action("OffSales"))">
                        已下架的规则
                    </a>
                </li>
            </ul>
          
            <table id="sample-table-1" class="table table-striped table-bordered table-hover">
                <thead>
                    <tr>
                        <th class="center">
                        </th>
                        <th>名称</th>
                        <th>兑换币种</th>
                        <th>目标币种</th>
                        <th>兑换比例</th>
                        <th>状态</th>
                        <th>
                            <i class="icon-time bigger-110 hidden-480"></i>
                            添加时间
                        </th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Count > 0)
                {
                    for (int i = 0; i < Model.Count; i++)
                    {

                <tr>
                    <td class="center text-muted" id="ExchangeCurrencyList">
                        @(i + 1)
                    </td>
                    
                    <td>
                        @Model[i].ExchangeName
                    </td>
                    <td>
                        @Model[i].FromCoinName
                    </td>
                    <td>
                        @Model[i].ToCoinName
                    </td>
                   
                    @*<td>
                        @{
                            var fromCoinUSDPrice = JN.Services.Manager.Stocks.getcurrentprice(coinList.Single(x=>x.ID== Model[i].FromCoinID));
                            var toCoinUSDPrice = JN.Services.Manager.Stocks.getcurrentprice(coinList.Single(x => x.ID == Model[i].ToCoinID));
                            string Rate = toCoinUSDPrice>0&& fromCoinUSDPrice >0? "自动获取汇率，当前汇率 1：" + (fromCoinUSDPrice / toCoinUSDPrice).ToString("F5"):"自动获取汇率失败，请尝试手动设置汇率！";
                        }
                        @(Model[i].ISEchangeRate ?? false ? ""+ Rate : "1:" + Model[i].Rate.ToString())
                    </td>*@
                    @if (Model[i].ISEchangeRate ?? false)
                    {
                        <td name="ISEchangeRate" id="@Model[i].ID" data-id="@Model[i].ID" data-fromcoinid="@Model[i].FromCoinID" data-tocoinid="@Model[i].ToCoinID">正在获取汇率请稍后...</td>
                    }
                    else
                    {
                        <td>@("1 : " + Model[i].Rate.ToDouble())</td>
                    }
                    <td>
                        @((Model[i].IsUse??true)?"使用中":"已下架")
                    </td>
                   
                    <td class="hidden-480">@Model[i].CreateTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                    <td>
                        <a href="@(Url.Action("Modify"))/@Model[i].ID" class="btn-action glyphicons edit btn-info" data-rel="tooltip" title="编辑">
                            <i></i>
                        </a>
                                    @if (Model[i].IsUse??true)
                                    {
                                <a href="@(Url.Action("ExchangeCommand", new { id = Model[i].ID, commandtype = "offsales" }))" class="btn-action glyphicons ban btn-info" data-rel="tooltip" title="禁用">
                                    <i></i>
                                </a>
                                    }
                                    else
                                    {
                                <a href="@(Url.Action("ExchangeCommand", new { id = Model[i].ID, commandtype = "onsales" }))" class="btn-action glyphicons ok btn-info" data-rel="tooltip" title="使用">
                                    <i></i>
                                </a>
                                    }
                        @*@if (!(Model[i].IsUse??true))
                                {
                                <a href="###" data-value="@Model[i].ID" class="btn-action glyphicons delete btn-info del" data-rel="tooltip" title="删除">
                                    <i></i>
                                </a>
                                }*@
                    </td>
                </tr>
                    }
                }
                </tbody>
            </table>


            <div class="separator top form-inline small">

                <!-- Pagination -->
                @Html.PagedListPager((IPagedList)Model, page => Url.Action(ViewContext.RouteData.Values["action"].ToString(),
                       JN.Services.Tool.StringHelp.GetQueryString(HttpUtility.ParseQueryString(Request.Url.Query), page)), new PagedListRenderOptions() { ContainerDivClasses = new string[] { "pagination pagination-small pull-right" } })


                <div class="clearfix"></div>
                <!-- // Pagination END -->

            </div><!-- /.table-responsive -->
        </div><!-- /span -->
    </div><!-- /row -->
    <!-- PAGE CONTENT ENDS -->

</div><!-- /.page-content -->
@section scripts{
    <script type="text/javascript">
        jQuery(function ($) {
            @*$(".del").on(ace.click_event, function () {
                var id = $(this).attr("data-value");
                bootbox.confirm('您确定要删除该规则吗?', function (result) {
                    if (result) {
                        location = '@(Url.Action("Delete"))/' + id;
                    }
                });
            });*@
            //自动获取汇率
            var ExchangeCurrencyList = $("[name='ISEchangeRate']");
            var time = 500;
            for (var i = 0; i < ExchangeCurrencyList.length; i++) {
                var id = "";
                var fromCoinID = "";
                var toCoinID = "";
                for (var j = 0; j < ExchangeCurrencyList[i].attributes.length; j++) {
                    switch (ExchangeCurrencyList[i].attributes[j].nodeName) {
                        case "data-id": id = ExchangeCurrencyList[i].attributes[j].nodeValue;
                            break;
                        case "data-fromcoinid": fromCoinID = ExchangeCurrencyList[i].attributes[j].nodeValue;
                            break;
                        case "data-tocoinid": toCoinID = ExchangeCurrencyList[i].attributes[j].nodeValue;
                            break;
                        default:
                            break;
                    }
                };
                setTimeout($.post('@Url.Action("GetEchangeRate")', { "id": id, "fromCoinID": fromCoinID, "toCoinID": toCoinID }, function (d) {
                    var result = JSON.parse(d.Message);
                    if (d.Status == 200) {
                        $("#" + result.id).html("自动获取汇率，当前兑换比例 1：" + result.Rate);
                    } else {
                        $("#" + result.id).html("自动获取汇率失败，请检查币种设置或请尝试手动设置兑换比例！");
                    }
                }, 'json'), time);
                time += 500;
            }
        })
    </script>
}