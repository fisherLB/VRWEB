@{
    Layout = "~/Areas/APP/Views/Shared/_Layout" + JN.Services.Tool.ConfigHelper.GetConfigString("Theme") + ".cshtml";
}@{
    Layout = "~/Areas/APP/Views/Shared/_Layout" + JN.Services.Tool.ConfigHelper.GetConfigString("Theme") + ".cshtml";
    //var userEntity = JN.Services.UserLoginHelper.CurrentUser();
    var cacheSysParam = MvcCore.Unity.Get<JN.Data.Service.ISysParamService>().ListCache("sysparams", x => x.ID < 6000);
    JN.Data.User Umodel = null;
    if (JN.Services.UserLoginHelper.CurrentUser() == null)
    {
        Response.Redirect(Url.Action("Index", "Login"));
    }
    else
    {
        Umodel = MvcCore.Unity.Get<JN.Data.Service.IUserService>().Single(JN.Services.UserLoginHelper.CurrentUser().ID);
    }
  



}


<div class="container clear-float main">
    @Html.Partial("/Areas/APP/Views/Home/_Security.cshtml")
    <div class="fr">
        <div class="setting-title">@T("安全设置")>@T("设置交易密码")</div>
        <div class="setting-panel">
            <form class="form-cont" id="step1">
                <div class="form-text">
                    @T("登录密码请不要与资金密码或其他网站密码一致")，@T("由此产生的账号被盗")，@T("本站概不负责")。
                </div>

                <div class="input-cont">
                    <span class="icon form-token"></span>
                    <input class="input" type="text" name="mobilecode" placeholder="@T("请输入手机验证码")">
                    <input class="input" type="hidden" id="phone" value="@T(Umodel.Mobile)">

                    <button class="link get-token" id="yzm" type="button" style="background: #fff;border: 0;">
                        @T("发送验证码")
                    </button>
                    <div class="form-tips"></div>
                </div>
                @*<div class="input-cont">
                    <span class="icon form-password"></span>
                    <input class="input" onfocus="this.type='password'" name="password2" placeholder="请输入旧交易密码">
                    <div class="form-tips"></div>
                    <div class="error-msg"></div>
                </div>*@
                <div class="input-cont">
                    <span class="icon form-password"></span>
                    <input class="input" onfocus="this.type='password'" name="newpassword2" placeholder="@T("请输入新交易密码")" maxlength="30">
                    <div class="form-tips"></div>
                    <div class="error-msg"></div>
                </div>
                <div class="input-cont">
                    <span class="icon form-password"></span>
                    <input class="input" onfocus="this.type='password'" name="confirmnewpassword2" placeholder="@T("请您再次输入新交易密码")" maxlength="30">
                    <div class="form-tips"></div>
                    <div class="error-msg"></div>
                </div>
                <a id="submit" class="btn submit" onclick="ChangePassword()">@T("确定提交")</a>
            </form>

        </div>
    </div>
</div>
<script>
    function ChangePassword() {
        $.post('/App/user/ResetTransactionPassword', $('#step1').serialize(), function (d) {
            if (d.Status != 200) {
                layer.msg(d.Message, { icon: 2 })

            } else {
                layer.msg("@T("设置成功")", { icon: 1 })
                window.location.href = "/App/home";
            }
        }, 'json');
    }
    


    //验证手机
    function codephone(thisval) {
        var phone = $("#phone").val();
        @*var myreg = /^(((13[0-9]{1})|(18[0-9]{1})|(15[0-9]{1})|(17[0-9]{1}))+\d{8})$/;
        if (!myreg.test(phone)) {
            layer.msg('@T("请输入有效的手机号码")', { icon: 2 });
            $("#phone").focus();
            return false;
        }*@
        if (phone != "") {
            layer.msg('@T("正在发送短信")，@T("请稍后")...');
            $.post("/App/user/SendMobileResetTran", { phone: phone }, function (data) {
                if (data.Status == 200) {
                    layer.msg('@T("短信已发送")', { icon: 1 });
                    time(thisval);
                } else {

                    layer.msg(data.Message, { icon: 2 });
                }
            });
        } else {
            layer.msg('@T("手机不能为空")', { icon: 2 });

            $("#phone").focus();
            return false;
        }
    }

    var yzmbtn = document.getElementById("yzm");
    if (yzmbtn != null) {
        var wait = 60;
        document.getElementById("yzm").disabled = false;
        function time(o) {
            if (wait == 0) {
                o.removeAttribute("disabled");
                o.innerHTML = "重新获取验证码";
                wait = 60;
            } else {
                o.setAttribute("disabled", true);
                o.innerHTML = "重新发送(" + wait + ")";
                wait--;
                setTimeout(function () {
                    time(o)
                },
                1000)
            }
        }
        document.getElementById("yzm").onclick = function () {
            codephone(this);
        }
    }

</script>